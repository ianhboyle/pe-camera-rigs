# VR180 Rig - Developer Guide

**Location**: `src/pe_camera_rigs/rigs/vr180/`

## Overview

Creates a stereoscopic VR180 camera rig with a multi-step workflow for crash-safe production. Outputs side-by-side stereo video suitable for YouTube VR.

## Module Structure

```
vr180/
├── __init__.py          # Registration
├── operators.py         # 4 workflow operators
├── panels.py            # VR180_PT_panel (child of main panel)
├── properties.py        # PE_VR180SceneSettings, PE_VR180RigSettings
└── rig.py              # create_vr180_rig() function
```

## Architecture

### Workflow Rig Pattern

The VR180 rig uses the **Workflow Rig** architecture:
- Multi-step production pipeline (4 steps)
- Each step is a separate operator
- Settings stored in property groups (Scene + Object)
- Crash-safe: can resume at any step
- Designed for production VR content

### Created Objects

- **Main Rig**: `VR180_Rig` (Empty, Circle display)
  - Parent object at eye level (Z=1.6m)
  - Stores rig-specific settings
  - IPD property drives camera positions via drivers

- **Left Camera**: `VR180_Camera_Left`
  - Fisheye panoramic camera (FISHEYE_EQUISOLID)
  - 190° FOV
  - Positioned at -IPD/2

- **Right Camera**: `VR180_Camera_Right`
  - Identical to left camera
  - Positioned at +IPD/2

## Implementation Details

### Property Groups

**PE_VR180SceneSettings** (Scene-level):
```python
bpy.types.Scene.pe_vr180_scene_settings = bpy.props.PointerProperty(type=PE_VR180SceneSettings)
```

Properties:
- `resolution_preset`: '4K', '5K', '8K'
- `render_quality`: 'PREVIEW', 'PRODUCTION', 'FINAL' (sample counts)
- `output_path`: Base output directory
- `lighting_preset`: Scene lighting setup
- `include_cyclorama`: Add cyclorama stage
- `include_reference`: Add person-scale reference

**PE_VR180RigSettings** (Object-level on rig):
```python
bpy.types.Object.pe_vr180_rig_settings = bpy.props.PointerProperty(type=PE_VR180RigSettings)
```

Properties:
- `ipd`: Inter-pupillary distance (millimeters, default 63mm)
- Drives camera positions via drivers

### IPD Driver System

The rig uses Blender drivers to link IPD to camera positions:

```python
# Left camera X location
d_left.expression = '-ipd / 2000.0'  # Convert mm to meters, divide by 2

# Right camera X location
d_right.expression = 'ipd / 2000.0'
```

**Why drivers?**
- Real-time updates when IPD changes
- No Python callbacks needed
- Survives .blend save/reload
- Efficient evaluation

### Camera Configuration

Both cameras configured identically:

```python
cam_data.type = 'PANO'
cam_data.cycles.panorama_type = 'FISHEYE_EQUISOLID'
cam_data.cycles.fisheye_fov = math.radians(190)
cam_data.lens = 5.2
```

**FISHEYE_EQUISOLID**: Preserves relative size of objects (unlike EQUIRECTANGULAR).

**190° FOV**: Slightly wider than 180° to allow for edge blending.

## Workflow Steps

### Step 1: Create Scene (VR180_OT_CreateScene)

**bl_idname**: `vr180.create_scene`

**Actions:**
1. Create VR180 rig with left/right cameras
2. Apply scene settings from property group
3. Set render resolution based on preset
4. Set render samples based on quality
5. Create output directory structure
6. Optionally add lighting preset
7. Optionally add cyclorama stage
8. Optionally add person-scale reference

**Error Handling:**
- `RuntimeError`: Rig creation failures
- `(IOError, OSError, PermissionError)`: Output directory issues

### Step 2: Render Sequences (VR180_OT_RenderSequences)

**bl_idname**: `vr180.render_sequences`

**Actions:**
1. Verify rig exists
2. Set output paths for left/right sequences
3. Render left camera sequence
4. Render right camera sequence
5. Save individual frames to output directory

**File Structure:**
```
output_path/
├── left/
│   ├── 0001.png
│   ├── 0002.png
│   └── ...
└── right/
    ├── 0001.png
    ├── 0002.png
    └── ...
```

**Error Handling:**
- `(KeyError, AttributeError)`: Missing rig or cameras
- `RuntimeError`: Render failures
- `(IOError, OSError, PermissionError)`: File write issues

### Step 3: Setup Compositor (VR180_OT_SetupCompositor)

**bl_idname**: `vr180.setup_compositor`

**Actions:**
1. Enable compositor use nodes
2. Clear existing nodes
3. Create Image nodes for left/right sequences
4. Create Transform nodes for positioning
5. Create Alpha Over node for side-by-side composition
6. Create File Output node for final render
7. Connect all nodes

**Node Layout:**
```
[Left Sequence] → [Transform] →┐
                                ├→ [Alpha Over] → [File Output]
[Right Sequence] → [Transform] →┘
```

**Error Handling:**
- `(KeyError, AttributeError)`: Node access issues
- `RuntimeError`: Compositor setup failures

### Step 4: Render YouTube VR (VR180_OT_RenderYouTube)

**bl_idname**: `vr180.render_youtube`

**Actions:**
1. Verify compositor setup
2. Render final side-by-side video
3. (Optional) Inject VR metadata using spatial-media tool
4. Output final YouTube-ready file

**Output Format:**
- Side-by-side stereo layout
- Left eye: left half of frame
- Right eye: right half of frame
- YouTube VR metadata (if spatial-media tool configured)

**Error Handling:**
- `RuntimeError`: Render failures
- `(IOError, OSError, PermissionError)`: File write/metadata injection issues

## User Workflow

1. **Configure settings** in VR180 panel
2. **Step 1**: Click "1. Create Scene" → rig created
3. **Adjust rig** (position, rotation, IPD)
4. **Step 2**: Click "2. Render Sequences" → left/right frames rendered
5. **Step 3**: Click "3. Setup Compositor" → compositor configured
6. **Step 4**: Click "4. Render YouTube VR" → final video output

**Crash Recovery**: If Blender crashes at any step, user can restart Blender and continue from next step (previous outputs preserved).

## Testing Checklist

- [ ] Step 1 creates rig with both cameras
- [ ] IPD property drives camera positions correctly
- [ ] Resolution presets set correct dimensions
- [ ] Render quality presets set correct samples
- [ ] Step 2 renders left/right sequences to separate folders
- [ ] Output directory structure created correctly
- [ ] Step 3 creates compositor node setup
- [ ] Compositor combines left/right correctly (side-by-side)
- [ ] Step 4 renders final video
- [ ] Spatial-media metadata injection (if tool configured)
- [ ] Crash recovery works (resume from any step)

## Known Limitations

1. **Cycles only**: Fisheye panoramic cameras require Cycles renderer
2. **Spatial-media tool**: Optional, must be configured in addon preferences
3. **Large file sizes**: VR180 renders can be very large (8K stereo)
4. **Sequential workflow**: Steps must be done in order (1→2→3→4)

## Camera Technical Details

**IPD (Inter-Pupillary Distance):**
- Default: 63mm (average human)
- Range: 55-70mm typical
- Affects stereo separation and depth perception

**Fisheye FOV:**
- 190° provides edge overlap for stitching/blending
- YouTube VR expects slightly wider than 180° to avoid edge artifacts

**Resolution Presets:**
- 4K: 3840×1920 (each eye 1920×1920)
- 5K: 5120×2560 (each eye 2560×2560)
- 8K: 7680×3840 (each eye 3840×3840)

## Related Files

- `src/pe_camera_rigs/rigs/vr180/rig.py` - `create_vr180_rig()` function
- `src/pe_camera_rigs/constants.py` - Object name constants
- `src/pe_camera_rigs/preferences.py` - `spatial_media_tool_path` preference
- `src/pe_camera_rigs/utils/scene_setup.py` - Lighting and cyclorama helpers

## See Also

- [Rig System Architecture](./README.md)
- [VR360 Mono Rig](./vr360mono.md) - Similar workflow pattern
- [Scene Setup Utilities](../utils.md#scene-setup-utilities)
